# 全功能落地与测试数据清理 — 你需要做的事

根据本次修改，请按以下顺序执行。

---

## 一、环境与依赖

### 1. 后端

- 在项目根目录执行：
  ```bash
  cd d:\projectapp\research-platform
  mvn clean install -DskipTests
  ```
- 若某子模块报错，可单独进入该模块执行 `mvn clean install -DskipTests`。

### 2. 前端

- 安装/更新依赖（已添加 pdfjs-dist、docx-preview、vue-websocket、annotator、pptxjs）：
  ```bash
  cd d:\projectapp\research-platform\research-frontend
  npm install
  ```

---

## 二、中间件（需先启动）

### 1. Nacos

- 启动 Nacos（如 `localhost:8848`）。
- 创建命名空间 `research-platform`（若配置里写了该 namespace）。

### 2. MySQL

- 确保库 `research_platform` 存在。
- **二选一**：
  - **全新库**：执行 `sql/schema.sql` 建表（已含 `test_data_flag`、`is_public`、`result_content`、`related_document_ids`、`project_detail` 等）。
  - **已有库**：直接启动**认证服务 research-auth**，由 **Flyway** 自动执行 `research-auth/src/main/resources/db/migration/` 下 V1～V7 迁移（含加字段、建表、清理测试数据）。

### 3. MongoDB

- 启动 MongoDB（文档服务存 GridFS 用）。
- 若使用独立集合 `document_files`、`result_attachments`，需在库里建集合并加 `testDataFlag` 字段/索引（见 `scripts/clean-test-data.md`）。

### 4. Elasticsearch（公开检索）

- 启动 ES（如 9200）。
- 索引 `public_document`、`public_result` 可在首次写入时由应用创建；若需预建，字段需含 `testDataFlag`(boolean)、`is_public` 等（见 `docs/MIDDLEWARE-INIT.md`）。

### 5. Redis

- 启动 Redis（网关/认证服务用，如 6379）。

---

## 三、启动顺序建议

1. **Nacos**
2. **MySQL** → 执行 schema 或交给 Flyway（通过先启 auth）
3. **MongoDB、Redis、Elasticsearch**
4. **research-auth**（会跑 Flyway，必须早于依赖同一库的其他服务）
5. **research-gateway**
6. **research-user、research-project、research-document、research-task、research-search、research-notification**
7. **前端**：`cd research-frontend && npm run serve`

---

## 四、你需要做的配置检查

- 各服务 `application.yml` 中：
  - **MySQL**：url、username、password、库名
  - **Nacos**：`server-addr`、`namespace`（如 research-platform），**必须配置**（文档服务通过 Nacos 服务发现调用项目服务）
  - **MongoDB**：文档服务连接串
  - **Elasticsearch**：search 服务 host/port
  - **Redis**：网关、认证服务 host/port
- 网关 `bootstrap.yml` 中 Nacos 地址与命名空间与各服务一致。

---

## 五、测试数据清理（你要怎么用）

- **自动**：每次认证服务启动时，Flyway 会执行到 V7，执行一次“删除 test_data_flag=1”的 MySQL 清理（仅对已执行过 V1～V6 的库）。
- **手动**：
  - MySQL：调用接口 **POST /api/system/clear/testData**（需管理员登录并带 JWT）。
  - MongoDB / ES：按 `scripts/clean-test-data.md` 在库里或通过 Kibana/脚本执行。

---

## 六、你要验证的功能点

| 项目 | 说明 |
|------|------|
| 文档上传 | 选项目、传文件，列表只显示非测试数据 |
| 文档预览/下载 | 使用 `/document/preview/{id}`、`/document/download/{id}`，可带 `versionNo` |
| 版本历史/回滚 | 版本列表、回滚接口均过滤 test_data_flag |
| 批注 | 添加/列表/删除（负责人可删） |
| 成果提交/编辑 | 提交带 result_content、related_document_ids；编辑页用 `/result/edit/{resultId}` |
| 成果详情/下载/删除 | 仅非测试数据可见、可下、可删 |
| 项目详情同步 | 上传文档或提交成果后，project_detail 表有对应 document_ids/result_ids 更新 |
| 公开检索 | 访问 **GET /api/search/public?keyword=xx&type=document**（可不带登录） |
| 测试数据清理 | 管理员调用 POST /api/system/clear/testData，再查库确认 test_data_flag=1 已删 |

---

## 七、若遇到问题

- **Flyway 报错**：检查 MySQL 用户是否有建表/删表权限；若某迁移已部分执行，可查 `flyway_schema_history` 表。
- **项目详情同步失败**：确认 Nacos 服务发现正常，项目服务已注册；检查文档服务日志中的同步错误信息。
- **公开检索 404/空**：确认网关已配置对 `/api/search/public` 放行，且 ES 已启、索引名与代码一致（public_document / public_result）。
- **列表仍见测试数据**：确认接口实现里列表/详情查询都带了 `test_data_flag=0`（本次修改已加），并确认库中该字段有值（0/1）。

完成以上步骤后，全功能落地与测试数据清理即可按设计运行；后续只需按需调整配置与权限（如角色、@PreAuthorize）。
