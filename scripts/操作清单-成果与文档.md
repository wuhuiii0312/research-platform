# 成果提交与文档上传 - 你需要做什么

按下面顺序做完，**成果归档**的「提交」和**文档共享**的「上传文档」即可正常使用。

---

## 一、修好成果表（解决提交成果 500 / Unknown column 'project_id'）

成果提交依赖 MySQL 里的 `project_result` 表，且列名必须是**下划线格式**（如 `project_id`、`submitter_id`）。  
请**任选一种**方式执行。

### 方式 A：重建表（推荐，表里没有重要数据时）

在项目根目录打开 PowerShell，执行：

```powershell
cd d:\projectapp\research-platform
mysql -u root -p research_platform < sql/migrate_project_result.sql
```

- 会提示输入 MySQL 的 root 密码。
- 脚本会**先删除**再**新建** `project_result` 表，表内原有数据会清空。
- 执行成功后，再在页面上「提交成果」应不再报 500。

### 方式 B：只改列名（表里已有数据且列名是 projectId 这种时）

若你确认表里列名是**驼峰**（如 `projectId`、`submitterId`），可只做列名重命名，不删数据：

```powershell
cd d:\projectapp\research-platform
mysql -u root -p research_platform < sql/migrate_project_result_rename_columns.sql
```

- 若执行时报错里出现 **Unknown column 'projectId'**，说明表已经是下划线格式，请改用**方式 A** 执行 `migrate_project_result.sql`。

---

## 二、确认文档上传所需环境

文档上传会：写 **MongoDB**（文件内容）、写 **MySQL** 的 `document_meta` 表（元数据）。  
请确认下面两点。

### 1. MongoDB 已启动

- 文档服务（research-document）会连 MongoDB 存文件。
- 默认连 `localhost:27017`，无认证；若你改过文档服务的 `application.yml`，以你配置为准。
- 未启动 MongoDB 时，上传可能一直转圈或报 500。

### 2. MySQL 里已有 document_meta 表

- 一般执行过 `sql/schema.sql` 就会有这张表。
- 若从未执行过完整建表，请在项目根目录执行一次：

```powershell
mysql -u root -p < sql/schema.sql
```

（会创建/覆盖多张表，注意备份已有数据。）

---

## 三、启动顺序（后端 + 前端）

### 1. 先启动基础服务（必须）

按顺序：

1. **MySQL**（3306）  
2. **Redis**（6379）  
3. **Nacos**（8848）  
4. **MongoDB**（27017，仅文档上传需要）

### 2. 再启动后端微服务（建议顺序）

在 `d:\projectapp\research-platform` 下可执行脚本：

```powershell
.\scripts\start-backend.ps1
```

或手动逐个启动（每个服务一个终端）：

1. research-auth（8081）  
2. research-gateway（9527）  
3. research-project（8082）  
4. research-task（8083）  
5. research-document（8084，文档上传需要）

### 3. 最后启动前端

```powershell
cd d:\projectapp\research-platform\research-frontend
npm run serve
```

浏览器访问：`http://localhost:8080`，用测试账号登录（如 member / 123456）。

---

## 四、如何自测

### 成果提交

1. 登录后进入 **成果归档** 或 某项目的 **成果**  tab。
2. 点击「提交」/「新增成果」，填项目、名称、类型等，提交。
3. 若仍报 500 且提示 **Unknown column 'project_id'**，说明成果表仍未按「一」中步骤修好，请再执行一次对应 SQL 脚本。

### 文档上传

1. 进入 **文档共享 / 文档管理**，点击「上传文档」。
2. 选择项目、选文件，点击确认上传。
3. 若失败，页面上会提示具体错误（如后端返回的 msg）；可据此检查：
   - 网关、文档服务是否都启动；
   - MongoDB 是否已启动；
   - MySQL 中是否有 `document_meta` 表。

---

## 五、简要对照表

| 现象 | 你需要做什么 |
|------|----------------|
| 提交成果报 500，提示 Unknown column 'project_id' | 执行 **一、方式 A** 或 **方式 B**（二选一） |
| 文档上传一直转圈或 500 | 确认 **二** 中 MongoDB 已启动、`document_meta` 表存在；并按 **三** 顺序启动服务 |
| 登录/接口 503 或 404 | 先启动 Nacos 和 research-auth，再启动网关；见 `scripts/START.md` |

完成以上步骤后，成果提交与文档上传应能正常使用。若某一步报错，把**完整报错信息**和**你执行到哪一步**发出来，便于继续排查。
