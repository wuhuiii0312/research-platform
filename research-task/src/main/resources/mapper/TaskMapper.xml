<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.research.task.mapper.TaskMapper">

    <resultMap id="TaskDetailMap" type="com.research.task.entity.Task">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="parent_id" property="parentId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="assignee_id" property="assigneeId"/>
        <result column="reporter_id" property="reporterId"/>
        <result column="status" property="status"/>
        <result column="priority" property="priority"/>
        <result column="type" property="type"/>
        <result column="estimated_hours" property="estimatedHours"/>
        <result column="actual_hours" property="actualHours"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="due_time" property="dueTime"/>
        <result column="progress" property="progress"/>
        <result column="tags" property="tags"/>
        <result column="attachment_count" property="attachmentCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="del_flag" property="delFlag"/>
        <result column="remark" property="remark"/>
        <result column="project_name" property="projectName"/>
        <result column="assignee_name" property="assigneeName"/>
        <result column="reporter_name" property="reporterName"/>
    </resultMap>

    <select id="selectTaskPage" resultType="com.research.task.entity.Task">
        SELECT t.*, p.name as project_name,
               u1.username as assignee_name, u2.username as reporter_name
        FROM task t
        LEFT JOIN project p ON t.project_id = p.id
        LEFT JOIN sys_user u1 ON t.assignee_id = u1.id
        LEFT JOIN sys_user u2 ON t.reporter_id = u2.id
        WHERE t.del_flag = 0
        <!-- 仅返回当前用户参与的项目下的任务（项目成员或负责人） -->
          AND t.project_id IN (
              SELECT pm.project_id
              FROM project_member pm
              WHERE pm.user_id = #{userId}
                AND pm.status = 1
          )
        <if test="query.projectId != null">
            AND t.project_id = #{query.projectId}
        </if>
        <if test="query.assigneeId != null">
            AND t.assignee_id = #{query.assigneeId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND t.status = #{query.status}
        </if>
        <if test="query.priority != null and query.priority != ''">
            AND t.priority = #{query.priority}
        </if>
        <if test="query.keyword != null and query.keyword != ''">
            AND (t.name LIKE CONCAT('%', #{query.keyword}, '%') OR t.description LIKE CONCAT('%', #{query.keyword}, '%'))
        </if>
        ORDER BY t.create_time DESC
    </select>

    <select id="selectTaskDetail" resultMap="TaskDetailMap">
        SELECT t.*, p.name as project_name,
               u1.username as assignee_name, u2.username as reporter_name
        FROM task t
        LEFT JOIN project p ON t.project_id = p.id
        LEFT JOIN sys_user u1 ON t.assignee_id = u1.id
        LEFT JOIN sys_user u2 ON t.reporter_id = u2.id
        WHERE t.id = #{id} AND t.del_flag = 0
    </select>

    <select id="selectUserTasks" resultType="com.research.task.entity.Task">
        SELECT t.*, p.name as project_name
        FROM task t
        LEFT JOIN project p ON t.project_id = p.id
        WHERE t.del_flag = 0 AND t.assignee_id = #{userId}
        <if test="status != null and status != ''">
            AND t.status = #{status}
        </if>
        ORDER BY t.create_time DESC
    </select>

    <select id="selectProjectTasks" resultType="com.research.task.entity.Task">
        SELECT t.*, u.username as assignee_name
        FROM task t
        LEFT JOIN sys_user u ON t.assignee_id = u.id
        WHERE t.project_id = #{projectId} AND t.del_flag = 0
        ORDER BY t.parent_id ASC, t.create_time ASC
    </select>

    <select id="selectTaskStatistics" resultType="map">
        SELECT
            COUNT(*) as totalTasks,
            SUM(CASE WHEN status = 'TODO' THEN 1 ELSE 0 END) as todoCount,
            SUM(CASE WHEN status = 'PROCESSING' THEN 1 ELSE 0 END) as processingCount,
            SUM(CASE WHEN status = 'REVIEW' THEN 1 ELSE 0 END) as reviewCount,
            SUM(CASE WHEN status = 'DONE' THEN 1 ELSE 0 END) as doneCount,
            AVG(IFNULL(progress, 0)) as avgProgress
        FROM task
        WHERE project_id = #{projectId} AND del_flag = 0
    </select>

    <select id="selectSubTasks" resultType="com.research.task.entity.Task">
        SELECT t.*, u.username as assignee_name
        FROM task t
        LEFT JOIN sys_user u ON t.assignee_id = u.id
        WHERE t.parent_id = #{parentId} AND t.del_flag = 0
        ORDER BY t.create_time ASC
    </select>
</mapper>
