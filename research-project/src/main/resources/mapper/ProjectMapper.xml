<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.research.project.mapper.ProjectMapper">

    <!-- 项目分页查询（含成员数统计） -->
    <select id="selectProjectPage" resultType="com.research.project.entity.Project">
        SELECT p.*, 
               u.name as leader_name,
               COALESCE(mc.member_count, 0) as member_count
        FROM project p
        LEFT JOIN sys_user u ON p.leader_id = u.id
        LEFT JOIN (
            SELECT project_id, COUNT(*) as member_count
            FROM project_member
            WHERE status IN (0, 1)
            GROUP BY project_id
        ) mc ON mc.project_id = p.id
        WHERE p.del_flag = 0
        <if test="query.name != null and query.name != ''">
            AND p.name LIKE CONCAT('%', #{query.name}, '%')
        </if>
        <if test="query.status != null and query.status != ''">
            AND p.status = #{query.status}
        </if>
        <if test="query.leaderId != null">
            AND p.leader_id = #{query.leaderId}
        </if>
        <if test="query.memberId != null">
            AND EXISTS (
            SELECT 1 FROM project_member pm
            WHERE pm.project_id = p.id AND pm.user_id = #{query.memberId}
            AND COALESCE(pm.status, 1) = 1
            )
        </if>
        ORDER BY p.create_time DESC
    </select>

    <!-- 项目详情查询 -->
    <select id="selectProjectDetail" resultType="com.research.project.entity.Project">
        SELECT p.*, u.username as leader_username, u.name as leader_name, u.email as leader_email
        FROM project p
                 LEFT JOIN sys_user u ON p.leader_id = u.id
        WHERE p.id = #{id} AND p.del_flag = 0
    </select>

    <!-- 项目统计 -->
    <select id="selectProjectStatistics" resultType="map">
        SELECT
        COUNT(*) as total_projects,
        SUM(CASE WHEN status = 'INIT' THEN 1 ELSE 0 END) as init_count,
        SUM(CASE WHEN status = 'PROCESSING' THEN 1 ELSE 0 END) as processing_count,
        SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_count,
        AVG(progress) as avg_progress
        FROM project
        WHERE del_flag = 0
        <if test="leaderId != null">
            AND leader_id = #{leaderId}
        </if>
    </select>

    <select id="countTaskByProjectId" resultType="int">
        SELECT COUNT(*) FROM task WHERE project_id = #{projectId} AND (del_flag = 0 OR del_flag IS NULL)
    </select>

    <select id="countDocumentByProjectId" resultType="int">
        SELECT COUNT(*) FROM document_meta WHERE project_id = #{projectId} AND (del_flag = 0 OR del_flag IS NULL)
    </select>

    <!-- 统计公开项目的公开文档数量 -->
    <select id="countPublicDocumentsByProjectIds" resultType="int">
        SELECT COUNT(*) FROM document_meta
        WHERE project_id IN
        <foreach collection="projectIds" item="projectId" open="(" separator="," close=")">
            #{projectId}
        </foreach>
        AND is_public = 1
        AND (del_flag = 0 OR del_flag IS NULL)
    </select>

    <!-- 立项审核列表：负责人+状态筛选，带申请人姓名 -->
    <select id="selectAuditPage" resultType="com.research.project.entity.Project">
        SELECT p.*, u.name AS applicant_name
        FROM project p
        LEFT JOIN sys_user u ON p.create_by = u.id
        WHERE p.del_flag = 0 AND p.leader_id = #{leaderId}
        <if test="statuses != null and statuses.size() > 0">
            AND p.status IN
            <foreach collection="statuses" item="s" open="(" separator="," close=")">
                #{s}
            </foreach>
        </if>
        ORDER BY p.create_time DESC
    </select>
</mapper>